<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Trading Scanner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; padding: 10px; }
    .market-box { padding: 10px; border: 1px solid #ccc; margin-bottom: 10px; border-radius: 4px; }
    table { border-collapse: collapse; width: 100%; font-size: 13px; }
    th, td { border: 1px solid #ddd; padding: 4px; text-align: center; }
    th { background: #f5f5f5; position: sticky; top: 0; }
    .positivo { background: #e3f7e3; }
    .neutro { background: #fdf7e3; }
    .negativo { background: #fbe5e5; }
    button { padding: 6px 10px; margin-bottom: 10px; }
  </style>
</head>
<body>
  <h3>Trading Scanner</h3>
  <button onclick="loadData()">Aggiorna</button>
  <div id="market" class="market-box"></div>
  <div id="info"></div>
  <table id="tabella">
    <thead>
      <tr>
        <th>#</th>
        <th>Ticker</th>
        <th>Categoria</th>
        <th>Prezzo</th>
        <th>Score</th>
        <th>Segnale</th>
        <th>Trend</th>
        <th>Momentum</th>
        <th>Entry</th>
        <th>SL</th>
        <th>TP</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    // ðŸ‘‡ SOSTITUISCI QUI sotto con l'URL reale del tuo backend Render
    const API_URL = "https://tr4mm-2.onrender.com/scan?min_score=0.01";

    function clsFromSignal(signal) {
      if (!signal) return "";
      if (signal.startsWith("Molto") || signal === "Positivo") return "positivo";
      if (signal.startsWith("Neutro")) return "neutro";
      return "negativo";
    }

    async function loadData() {
      document.getElementById("info").textContent = "Caricamento...";
      const tbody = document.querySelector("#tabella tbody");
      tbody.innerHTML = "";
      document.getElementById("market").innerHTML = "";

      try {
        const res = await fetch(API_URL);
        const data = await res.json();

        // Box stato mercato
        const market = data.market || {};
        const phase = market.phase || "N/D";
        let htmlMarket = `<strong>Stato mercato:</strong> ${phase}`;
        const det = market.details || {};
        htmlMarket += "<ul>";
        for (const k in det) {
          const d = det[k];
          htmlMarket += `<li>${k}: prezzo ${d.price}, 20d ${d.return_20d_pct}%, 60d ${d.return_60d_pct}%</li>`;
        }
        htmlMarket += "</ul>";
        document.getElementById("market").innerHTML = htmlMarket;

        // Tabella titoli/ETF
        const results = data.assets || [];
        document.getElementById("info").textContent =
          `Strumenti trovati: ${results.length}`;

        results.forEach((row, idx) => {
          const tr = document.createElement("tr");
          const cls = clsFromSignal(row.signal_label);
          if (cls) tr.classList.add(cls);

          tr.innerHTML = `
            <td>${idx + 1}</td>
            <td>${row.ticker}</td>
            <td>${row.categoria}</td>
            <td>${row.price.toFixed(3)}</td>
            <td>${row.score.toFixed(3)}</td>
            <td>${row.signal_label}</td>
            <td>${row.trend_label}</td>
            <td>${row.momentum_label}</td>
            <td>${row.entry_price.toFixed(3)}</td>
            <td>${row.stop_loss.toFixed(3)}</td>
            <td>${row.take_profit.toFixed(3)}</td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error(err);
        document.getElementById("info").textContent = "Errore nel caricamento";
      }
    }

    // carica all'apertura
    loadData();
    // aggiornamento automatico ogni 60 secondi
    setInterval(loadData, 60000);
  </script>
</body>
</html>
